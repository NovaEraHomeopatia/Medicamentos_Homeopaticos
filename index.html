<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consulta de Medicamentos | Nova Era</title>

  <!-- DataTables + jQuery (CDN) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

  <!-- PapaParse para ler CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
    h1 { margin-bottom: 6px; }
    .topo { margin-bottom: 10px; color: #444; }

    .meta { margin: 6px 0 14px; font-size: 13px; color: #555; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .pill { background: #f6f7f9; border: 1px solid #e3e6ea; padding: 6px 10px; border-radius: 999px; }

    .loading { margin: 12px 0; }
    .erro { color: #b00020; font-weight: bold; margin: 12px 0; }

    .dica { margin: 10px 0 16px; padding: 10px; background: #f6f7f9; border: 1px solid #e3e6ea; border-radius: 8px; color: #333; }

    table.dataTable thead th { white-space: nowrap; }
    #tabela td.col-medicamento { font-weight: 600; }

    .rodape { margin-top: 14px; font-size: 12px; color: #666; }
  </style>
</head>

<body>
  <h1>Consulta de Medicamentos</h1>

  <div class="topo">
    Para consultar, digite o nome do medicamento no campo <b>Buscar medicamento</b> abaixo à direita.
  </div>

  <!-- Data de atualização -->
  <div class="meta">
    <div class="pill"><b>Catálogo atualizado em</b> <span id="dataAtualizacao">carregando…</span></div>
  </div>

  <div class="dica">
    <b>Dicas rápidas:</b>
    <ul style="margin: 8px 0 0 18px;">
      <li>Você pode digitar só parte do nome (ex.: <b>arnica</b>).</li>
      <li>Para ver mais resultados de uma vez, use “Mostrar” e selecione <b>100</b>.</li>
    </ul>
  </div>

  <div id="status" class="loading">Carregando dados...</div>

  <table id="tabela" class="display" style="width:100%">
    <thead></thead>
    <tbody></tbody>
  </table>

  <div class="rodape">
    Se a lista for atualizada, basta substituir o arquivo <b>dados.csv</b> no repositório.
  </div>

  <script>
    const ARQUIVO_CSV = "dados.csv";
    const DELIMITADOR = ";";
    const CABECALHO_PADRAO = ["Medicamento", "Escala", "Potências disponíveis"];

    // Ajustado para o seu caso:
    const GITHUB_USER = "NovaEraHomeopatia";
    const GITHUB_REPO = "Medicamentos_Homeopaticos";

    function normalizarPotencias(txt) {
      const s = (txt ?? "").toString();
      return s.replace(/\s+/g, " ").trim();
    }

    function formatarDataNumericaBR(d) {
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    async function atualizarDataDoCatalogo() {
      const el = document.getElementById("dataAtualizacao");
      if (!el) return;

      // Plano A: Last-Modified via HEAD em dados.csv
      try {
        const resp = await fetch(ARQUIVO_CSV, { method: "HEAD", cache: "no-store" });
        const lm = resp.headers.get("Last-Modified");
        if (lm) {
          el.textContent = formatarDataNumericaBR(new Date(lm));
          return;
        }
      } catch (e) {}

      // Plano B: último commit do dados.csv via API do GitHub
      try {
        const api = `https://api.github.com/repos/${encodeURIComponent(GITHUB_USER)}/${encodeURIComponent(GITHUB_REPO)}/commits?path=${encodeURIComponent(ARQUIVO_CSV)}&per_page=1`;
        const resp = await fetch(api, { cache: "no-store" });
        if (!resp.ok) throw new Error("Falha na API do GitHub");
        const data = await resp.json();
        const iso = data?.[0]?.commit?.committer?.date || data?.[0]?.commit?.author?.date;
        if (iso) {
          el.textContent = formatarDataNumericaBR(new Date(iso));
          return;
        }
      } catch (e) {}

      el.textContent = "indisponível";
    }

    function montarTabela(cabecalho, linhas) {
      const thead = document.querySelector("#tabela thead");
      const trHead = document.createElement("tr");
      cabecalho.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col || "";
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      const tbody = document.querySelector("#tabela tbody");

      linhas.forEach(linha => {
        const temConteudo = linha.some(c => String(c ?? "").trim() !== "");
        if (!temConteudo) return;

        const tr = document.createElement("tr");

        const medicamento = (linha[0] ?? "").toString();
        const escala = (linha[1] ?? "").toString();
        const potencias = normalizarPotencias(linha[2] ?? "");

        const td0 = document.createElement("td");
        td0.textContent = medicamento;
        td0.className = "col-medicamento";
        tr.appendChild(td0);

        const td1 = document.createElement("td");
        td1.textContent = escala;
        tr.appendChild(td1);

        const td2 = document.createElement("td");
        td2.textContent = potencias;
        tr.appendChild(td2);

        tbody.appendChild(tr);
      });

      const dt = $('#tabela').DataTable({
        pageLength: 100,
        lengthMenu: [10, 25, 50, 100],
        order: [],
        language: {
          search: "Buscar medicamento:",
          lengthMenu: "Mostrar _MENU_ registros",
          info: "Mostrando de _START_ até _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 até 0 de 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros no total)",
          loadingRecords: "Carregando...",
          zeroRecords: "Nenhum medicamento encontrado",
          emptyTable: "Nenhum dado disponível na tabela",
          paginate: { first: "Primeiro", previous: "Anterior", next: "Próximo", last: "Último" }
        }
      });

      // Busca só na coluna Medicamento
      const $input = $('div.dataTables_filter input');
      $input.off('keyup.DT input.DT');
      $input.on('input', function () {
        const q = this.value || "";
        dt.columns().search("");
        dt.column(0).search(q).draw();
      });

      document.getElementById("status").textContent = "";
    }

    function carregarCSV() {
      Papa.parse(ARQUIVO_CSV, {
        download: true,
        header: false,
        skipEmptyLines: false,
        delimiter: DELIMITADOR,
        complete: function(results) {
          if (!results || !results.data || results.data.length === 0) {
            document.getElementById("status").innerHTML =
              '<div class="erro">Não foi possível ler o CSV. Verifique se o arquivo <b>dados.csv</b> está na mesma pasta do <b>index.html</b>.</div>';
            return;
          }

          let cabecalho = results.data[0] || [];
          let linhas = results.data.slice(1);

          const cabecalhoValido = cabecalho.length >= 3 && cabecalho.some(x => String(x ?? "").trim() !== "");
          if (!cabecalhoValido) {
            cabecalho = CABECALHO_PADRAO;
            linhas = results.data;
          }

          cabecalho = [
            (cabecalho[0] ?? CABECALHO_PADRAO[0]).toString(),
            (cabecalho[1] ?? CABECALHO_PADRAO[1]).toString(),
            (cabecalho[2] ?? CABECALHO_PADRAO[2]).toString()
          ];

          montarTabela(cabecalho, linhas);
        },
        error: function(err) {
          document.getElementById("status").innerHTML =
            '<div class="erro">Erro ao carregar o CSV: ' + (err?.message || err) + '</div>';
        }
      });
    }

    // Start
    atualizarDataDoCatalogo();
    carregarCSV();
  </script>
</body>
</html>